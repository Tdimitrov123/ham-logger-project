<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ham Radio Contest Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Персонализиран стил за модерен тъмен режим (Dark Mode) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Тъмен фон */
            color: #f3f4f6; /* Светъл текст */
        }
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .card {
            background-color: #374151; /* По-светъл цвят за "картите" */
            border: 1px solid #4b5563;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }
        h1, h2 {
            color: #d1d5db;
        }
        label {
            color: #9ca3af;
        }
        input[type="text"], input[type="number"], select {
            background-color: #4b5563; /* Полетата са по-тъмни */
            color: #f3f4f6;
            border: 1px solid #6b7280;
            padding: 0.75rem;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            border-color: #6366f1; /* Индиго за фокус */
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }

        /* Основен бутон за логване: Ярко зелено */
        .btn-primary {
            background-color: #10b981;
            color: #0d121c; /* По-тъмен текст за по-добър контраст */
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        
        /* Бутон за Експорт: Кехлибар/Оранжево */
        .btn-export {
            background-color: #f59e0b;
            color: #1f2937;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-export:hover {
            background-color: #d97706;
        }

        .qso-log {
            max-height: 40vh;
            overflow-y: auto;
        }
        /* Стилове за лога в тъмен режим */
        .log-item {
            border-color: #4b5563 !important;
        }
        
        /* Стил за модалния прозорец */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #374151;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-indigo-400 mb-8 text-center">
            <span class="text-white">Ham Radio</span> Contest Logger
        </h1>

        <!-- 1. Настройки на оператора (Your Details) + Банд и Режим -->
        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-white">Твоите настройки</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Твоите данни -->
                <div>
                    <label for="myCall" class="block text-sm font-medium mb-1">Твоята позивна (Call)</label>
                    <input type="text" id="myCall" placeholder="LZ1XYZ" class="w-full" value="LZ5A">
                </div>
                <div>
                    <!-- ПРОМЕНЕНО: Добавена е препоръка за 4 или 6 символа -->
                    <label for="myLocator" class="block text-sm font-medium mb-1">Твоят локатор (Locator) - 4/6 знака</label>
                    <input type="text" id="myLocator" placeholder="KN32LV" class="w-full uppercase" value="KN32LV">
                </div>
                <div>
                    <label for="contestName" class="block text-sm font-medium mb-1">Име на контеста</label>
                    <input type="text" id="contestName" placeholder="CQ-WW-SSB" class="w-full uppercase" value="IARU-HF-2025">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mt-4">
                <!-- Избор на Банд (преместено) -->
                <div>
                    <label for="band" class="block text-sm font-medium mb-1">Текуща Банда (Band)</label>
                    <select id="band" class="w-full p-2">
                        <option value="160">160м (1.8MHz)</option>
                        <option value="80">80м (3.5MHz)</option>
                        <option value="40">40м (7MHz)</option>
                        <option value="20" selected>20м (14MHz)</option>
                        <option value="15">15м (21MHz)</option>
                        <option value="10">10м (28MHz)</option>
                        <option value="6">6м (50MHz)</option>
                        <option value="2m">2м (144MHz)</option>
                        <option value="70cm">70см (433MHz)</option>
                    </select>
                </div>
                <!-- Избор на Режим (преместено) -->
                <div>
                    <label for="mode" class="block text-sm font-medium mb-1">Текущ Режим (Mode)</label>
                    <select id="mode" class="w-full p-2">
                        <option value="SSB">SSB</option>
                        <option value="CW">CW</option>
                        <option value="FM">FM</option>
                        <option value="RY">RTTY</option>
                    </select>
                </div>
                <!-- Изпратен RST (фиксиран) -->
                <div>
                    <label for="rstSent" class="block text-sm font-medium mb-1">Изпратен RST</label>
                    <input type="text" id="rstSent" value="599" class="w-full" disabled>
                </div>
            </div>
        </div>

        <!-- 2. Форма за въвеждане на QSO -->
        <div class="card mb-6 border-indigo-500 border-2">
            <h2 class="text-xl font-semibold mb-4 text-white">Въвеждане на QSO</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Позивна -->
                <div>
                    <label for="dxCall" class="block text-sm font-medium mb-1">Позивна (DX Call)</label>
                    <input type="text" id="dxCall" placeholder="K1ABC" class="w-full text-xl font-bold uppercase" autofocus>
                </div>
                <!-- Получен обмен (Serial/Locator) -->
                <div>
                    <label for="serialNumber" class="block text-sm font-medium mb-1">Получен Обмен (Serial/Locator)</label>
                    <input type="text" id="serialNumber" placeholder="001 / KN32LV" class="w-full text-xl font-bold">
                </div>
                <!-- Локатор на кореспондента (DX Locator - за VHF/HF) -->
                <div>
                    <label for="dxLocator" class="block text-sm font-medium mb-1">DX Локатор (За КВ/УКВ)</label>
                    <input type="text" id="dxLocator" placeholder="KN42XX" class="w-full text-xl font-bold uppercase">
                </div>
            </div>
            
            <button onclick="addQSO()" class="btn-primary w-full mt-6">
                <span class="text-2xl font-black">LOG QSO (Enter)</span>
            </button>
        </div>

        <!-- 3. Лог на QSO-тата и експорт -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-white">
                Лог на QSO-тата (<span id="qsoCount" class="text-yellow-400 font-extrabold text-2xl">0</span>)
                <span id="authStatus" class="text-xs text-green-500 font-normal"> (Свързване...)</span>
            </h2>
            
            <!-- Показване на лога -->
            <div id="qsoLog" class="qso-log border p-3 rounded-lg bg-gray-600 mb-4 text-sm whitespace-pre-wrap">
                <p class="text-center text-gray-400">Зареждане на лога...</p>
            </div>

            <!-- БУТОН ЗА ЕКСПОРТ -->
            <button onclick="openExportModal()" class="btn-export w-full">
                Експорт на Лог (Избор на Формат)
            </button>
        </div>
        
        <!-- Скрито поле за съобщения -->
        <div id="messageBox" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden transition-all"></div>
    </div>
    
    <!-- МОДАЛЕН ПРОЗОРЕЦ ЗА ЕКСПОРТ -->
    <div id="exportModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center">Избери формат за Експорт</h3>
            <p class="text-sm text-gray-400 mb-6 text-center">Избери желания формат на файла:</p>
            
            <div class="grid grid-cols-2 gap-4">
                <!-- Cabrillo -->
                <button onclick="exportQSO('cabrillo')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    Cabrillo (.log)
                </button>
                
                <!-- ADIF -->
                <button onclick="exportQSO('adif')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    ADIF (.adi)
                </button>

                <!-- КОНТЕСТ TXT (EDI-подобен) -->
                <button onclick="exportQSO('contest_txt')" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">
                    Контест TXT (.txt)
                </button>

                <!-- Cancel -->
                <button onclick="closeExportModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition-colors">
                    Отказ
                </button>
            </div>
        </div>
    </div>
    <!-- КРАЙ НА МОДАЛНИЯ ПРОЗОРЕЦ -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобални променливи за Firebase
        let db = null; // Инициализираме с null
        let auth = null; // Инициализираме с null
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Глобален масив за съхранение на QSO-тата
        window.qsoList = [];
        // Сериен номер, който изпращаме (автоматично нараства)
        window.sentSerialNumber = 1; 

        // Присвояване на глобалните функции към window
        window.addQSO = addQSO;
        window.openExportModal = openExportModal;
        window.closeExportModal = closeExportModal;
        window.exportQSO = exportQSO;

        // Инициализация на Firebase и автентикация
        async function initializeFirebase() {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                console.warn("FIREBASE WARNING: Missing or empty __firebase_config. The logger will run without cloud persistence.");
                document.getElementById('authStatus').textContent = '(Логва локално, без облак)';
                document.getElementById('qsoLog').innerHTML = '<p class="text-center text-yellow-400 p-4">Няма връзка с базата данни (липсва конфигурация). Логът ще се загуби при презареждане.</p>';
                return false; 
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                document.getElementById('authStatus').textContent = '(Свързан с облака)';
                return true; 
                
            } catch (error) {
                console.error("Грешка при инициализация на Firebase:", error);
                document.getElementById('authStatus').textContent = '(Грешка при свързване)';
                document.getElementById('qsoLog').innerHTML = '<p class="text-center text-red-400 p-4">Критична грешка при свързване с Firebase. Вижте конзолата за детайли.</p>';
                return false; 
            }
        }

        // Зареждане на данните от Firestore
        function loadDataFromFirestore() {
            if (!db || !auth) return;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    // Използваме PRIVATE COLLECTION PATH: /artifacts/{appId}/users/{userId}/contest_logs/qso_data
                    const logDocRef = doc(db, `artifacts/${appId}/users/${userId}/contest_logs/qso_data`);

                    onSnapshot(logDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            window.qsoList = data.qsoList || [];
                            window.sentSerialNumber = data.sentSerialNumber || 1;
                        } else {
                            // Ако документът не съществува, запазваме първоначалното състояние
                            saveState(); 
                        }
                        updateQsoDisplay();
                    }, (error) => {
                        console.error("Грешка при слушане на Firestore:", error);
                        showMessage('Грешка при зареждане на лога от облака.', true);
                        updateQsoDisplay();
                    });
                }
            });
        }

        // Запазване на състоянието във Firestore
        async function saveState() {
            if (!userId || !db) return;

            const logData = {
                qsoList: window.qsoList,
                sentSerialNumber: window.sentSerialNumber,
                lastUpdate: new Date().toISOString()
            };

            try {
                // Използваме PRIVATE COLLECTION PATH: /artifacts/{appId}/users/{userId}/contest_logs/qso_data
                const logDocRef = doc(db, `artifacts/${appId}/users/${userId}/contest_logs/qso_data`);
                await setDoc(logDocRef, logData);
            } catch (error) {
                console.error("Грешка при запис във Firestore:", error);
                showMessage('Грешка при запазване на QSO. Проверете връзката си.', true);
            }
        }

        // --- ИНИЦИАЛИЗАЦИЯ И СЪБИТИЯ ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase().then((success) => {
                if (success) {
                    loadDataFromFirestore();
                } else {
                    updateQsoDisplay();
                }
            });
            
            document.getElementById('dxCall').addEventListener('keyup', handleEnterKey);
            document.getElementById('serialNumber').addEventListener('keyup', handleEnterKey);
            document.getElementById('dxLocator').addEventListener('keyup', handleEnterKey);

            // Затваряне на модала при клик извън него
            document.getElementById('exportModal').addEventListener('click', (e) => {
                if (e.target.id === 'exportModal') {
                    closeExportModal();
                }
            });
        });

        function handleEnterKey(event) {
            if (event.keyCode === 13) {
                addQSO();
                event.preventDefault(); 
            }
        }

        function showMessage(msg, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.classList.remove('bg-red-500', 'bg-green-500', 'hidden');
            box.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'block');
            setTimeout(() => {
                box.classList.remove('block');
                box.classList.add('hidden');
            }, 3000);
        }

        function getCurrentTimeUTC() {
            const now = new Date();
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, '0');
            const day = String(now.getUTCDate()).padStart(2, '0');
            const hours = String(now.getUTCHours()).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');

            return {
                // Годината с две цифри за EDI/TXT
                dateYYMMDD: `${String(year).slice(-2)}${month}${day}`, 
                dateISO: `${year}-${month}-${day}`, // За Cabrillo/ADIF
                timeHHMM: `${hours}${minutes}`
            };
        }

        function isLocatorContest(band) {
            return band === '2m' || band === '70cm' || band === '6';
        }
        
        // Функция за изчисляване на разстоянието между два локатора (просто приближение в км)
        function calculateDistance(loc1, loc2) {
            // Изисква 4-символни локатори (напр. KN32)
            if (loc1.length < 4 || loc2.length < 4) return 0;

            const degToRad = (deg) => deg * (Math.PI / 180);
            
            // Преобразуване на 4-символен локатор в приблизителни географски координати (център на квадрат)
            function locatorToLatLng(loc) {
                // Използваме само първите 4 знака за грубо изчисление
                const lon = (loc.charCodeAt(0) - 'A'.charCodeAt(0)) * 20 - 180 + 1;
                const lat = (loc.charCodeAt(1) - 'A'.charCodeAt(0)) * 10 - 90 + 0.5;
                const lonSub = (parseInt(loc[2], 10) * 2) + 0.16666666666666666;
                const latSub = (parseInt(loc[3], 10) * 0.8333333333333333) + 0.041666666666666664;
                return { lat: lat + latSub, lon: lon + lonSub };
            }

            const R = 6371; // Радиус на Земята в km
            const c1 = locatorToLatLng(loc1.substring(0, 4));
            const c2 = locatorToLatLng(loc2.substring(0, 4));

            const lat1Rad = degToRad(c1.lat);
            const lat2Rad = degToRad(c2.lat);
            const dLat = degToRad(c2.lat - c1.lat);
            const dLon = degToRad(c2.lon - c1.lon);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            const distance = R * c; 
            return Math.round(distance);
        }

        function addQSO() {
            const dxCall = document.getElementById('dxCall').value.trim().toUpperCase();
            const receivedExchangeRaw = document.getElementById('serialNumber').value.trim();
            let dxLocatorInput = document.getElementById('dxLocator').value.trim().toUpperCase(); 
            
            const band = document.getElementById('band').value;
            const mode = document.getElementById('mode').value;
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const myLocator = document.getElementById('myLocator').value.trim().toUpperCase(); 
            const rstSent = document.getElementById('rstSent').value;
            const rstRcvd = '599'; // Фиксирано 

            if (!dxCall || !myCall) {
                showMessage('Моля, попълни Позивна на кореспондента и Твоята позивна!', true);
                return;
            }
            
            // НОВА ПРОВЕРКА: Ако myLocator липсва или е по-малко от 4 знака, предупреждаваме
            if (myLocator.length < 4) {
                 showMessage('ВНИМАНИЕ: Попълни "Твоят локатор" с поне 4 знака (KN32), за да се изчисли разстоянието!', true);
                 // НЕ правим return, за да може QSO да се логне, но без разстояние
            }


            const timeUTC = getCurrentTimeUTC();
            
            const isLocator = isLocatorContest(band);

            // Обмен, който изпращаме (Serial или My Locator)
            const exchangeSent = isLocator ? myLocator : String(window.sentSerialNumber).padStart(3, '0'); 
            
            // Обмен, който получаваме (Serial или DX Locator)
            let exchangeRcvd = receivedExchangeRaw;
            if (!exchangeRcvd && isLocator) {
                // Ако няма въведен сериен номер/локатор, опитваме да вземем DX локатора за УКВ
                exchangeRcvd = dxLocatorInput;
            }
            if (!isLocator) {
                // За КВ, серийният номер трябва да е три цифри
                exchangeRcvd = exchangeRcvd.padStart(3, '0');
            } else {
                // За УКВ, локаторът е най-важен
                exchangeRcvd = exchangeRcvd.toUpperCase();
            }

            
            // Определяне на DX Локатор за съхранение:
            let finalDxLocator = '';
            if (isLocator) {
                // За УКВ, DX Locator е exchangeRcvd, освен ако exchangeRcvd не е сериен номер (трябва да се внимава)
                finalDxLocator = (exchangeRcvd.length >= 4 && isNaN(parseInt(exchangeRcvd[0]))) ? exchangeRcvd : dxLocatorInput;
            } else {
                // За КВ, DX Locator е dxLocatorInput (може да е празен)
                finalDxLocator = dxLocatorInput;
            }
            // Премахваме водещи и завършващи интервали
            finalDxLocator = finalDxLocator.trim().toUpperCase();


            // Изчисляване на разстоянието за Контест TXT
            const dxLocForDistance = finalDxLocator;

            // КОРИГИРАНА ЛОГИКА: Изчисляваме разстоянието само ако и двата локатора имат поне 4 знака
            const calculatedDistance = (myLocator.length >= 4 && dxLocForDistance.length >= 4)
                ? calculateDistance(myLocator, dxLocForDistance)
                : '';


            const newQSO = {
                band: band, 
                mode: mode, 
                dateISO: timeUTC.dateISO, 
                dateYYMMDD: timeUTC.dateYYMMDD,
                timeHHMM: timeUTC.timeHHMM,
                myCall: myCall,
                myLocator: myLocator,
                rstSent: rstSent,
                exchangeSent: exchangeSent, 
                dxCall: dxCall,
                rstRcvd: rstRcvd, 
                exchangeRcvd: exchangeRcvd,
                freq: getCabrilloBandFreq(band).replace('M', '').replace('.', ''),
                dxLocator: finalDxLocator, 
                distanceKm: calculatedDistance // <-- Тук вече ще има стойност, ако myLocator е попълнен
            };
            
            window.qsoList.push(newQSO);
            
            // Нарастваме серийния номер само ако не е УКВ (там се използва локатор)
            if (!isLocator) {
                window.sentSerialNumber++; 
            }
            
            if(db) {
                saveState();
                showMessage(`Успешно логнато QSO с ${dxCall}.`, false);
            } else {
                showMessage(`Успешно логнато QSO с ${dxCall} (Локално).`, false);
            }

            document.getElementById('dxCall').value = '';
            document.getElementById('serialNumber').value = '';
            document.getElementById('dxLocator').value = '';
            document.getElementById('dxCall').focus();
            
            updateQsoDisplay();
        }

        function updateQsoDisplay() {
            const logElement = document.getElementById('qsoLog');
            const countElement = document.getElementById('qsoCount');
            logElement.innerHTML = ''; 
            
            countElement.textContent = window.qsoList.length;

            if (window.qsoList.length === 0) {
                const status = document.getElementById('authStatus').textContent;
                if (status.includes('Зареждане') || status.includes('Грешка')) {
                    logElement.innerHTML = '<p class="text-center text-gray-400 p-4">Зареждане на лога...</p>';
                } else {
                    logElement.innerHTML = '<p class="text-center text-gray-400 p-4">Няма логнати QSO-та.</p>';
                }
                return;
            }

            const displayList = window.qsoList.slice(-10).reverse(); 
            
            let displayHtml = '';
            displayList.forEach(qso => {
                const bandDisplay = qso.band.includes('m') || qso.band.includes('cm') ? qso.band : `${qso.band}м`;
                const isLoc = isLocatorContest(qso.band);
                const exchangeLabel = isLoc ? 'LOC' : '№';
                // Премахваме нулите отпред за показване
                const exchangeValue = isLoc ? qso.exchangeRcvd : qso.exchangeRcvd.replace(/^0+/, ''); 
                
                // Допълнителна информация за УКВ (разстояние)
                const distanceInfo = qso.distanceKm ? ` (${qso.distanceKm} км)` : '';
                // Показваме DX локатора, ако е наличен
                const locInfo = qso.dxLocator ? ` / ${qso.dxLocator}` : '';


                displayHtml += `<div class="p-2 border-b log-item last:border-b-0 flex justify-between items-center flex-wrap">
                    <span class="font-mono text-gray-300 w-1/4">${qso.timeHHMM}Z</span>
                    <span class="font-bold text-indigo-400 w-1/4">${qso.dxCall}</span>
                    <span class="text-xs text-gray-400 w-1/4">${bandDisplay}/${qso.mode}</span>
                    <span class="text-yellow-400 font-extrabold w-1/4 text-right">${exchangeLabel} ${exchangeValue}${locInfo}${distanceInfo}</span>
                </div>`;
            });
            logElement.innerHTML = displayHtml;
        }


        // --- ФУНКЦИИ ЗА ЕКСПОРТ (MODAL + GENERATORS) ---

        function openExportModal() {
            if (window.qsoList.length === 0) {
                showMessage('Няма логнати QSO-та за експорт.', true);
                return;
            }
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportQSO(format) {
            closeExportModal();

            let content = '';
            let fileExt = '';
            let mimeType = 'text/plain;charset=utf-8';
            let fileName = '';

            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const contestName = document.getElementById('contestName').value.trim().toUpperCase();
            const baseFileName = `${myCall}_${contestName}_LOG`;

            switch (format) {
                case 'cabrillo':
                    content = generateCabrilloLog();
                    fileExt = 'log';
                    fileName = `${baseFileName}.${fileExt}`;
                    break;
                case 'adif':
                    content = generateAdifLog();
                    fileExt = 'adi';
                    fileName = `${baseFileName}.${fileExt}`;
                    break;
                case 'contest_txt':
                    content = generateEdiLog(); // Използваме EDI/TXT генератора
                    fileExt = 'txt';
                    fileName = `${baseFileName}.${fileExt}`;
                    break;
                default:
                    showMessage('Неподдържан формат за експорт.', true);
                    return;
            }

            downloadFile(content, fileName, mimeType);
            showMessage(`Успешно генериран и изтеглен файл във формат: ${format.toUpperCase().replace('_TXT', ' TXT')}`, false);
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getCabrilloBandFreq(band) {
            switch(band) {
                case '160': return '1.8M';
                case '80': return '3.5M';
                case '40': return '7M';
                case '20': return '14M';
                case '15': return '21M';
                case '10': return '28M';
                case '6': return '50M';
                case '2m': return '144M';
                case '70cm': return '433M';
                default: return '14M';
            }
        }
        
        // --- ГЕНЕРАТОРИ НА ФОРМАТИ ---

        // 1. Cabrillo Generator (.log)
        function generateCabrilloLog() {
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const contestName = document.getElementById('contestName').value.trim().toUpperCase();
            const myLocator = document.getElementById('myLocator').value.trim().toUpperCase();
            
            let cabrilloContent = `START-OF-LOG: 3.0\n`;
            cabrilloContent += `CONTEST: ${contestName}\n`;
            cabrilloContent += `CALLSIGN: ${myCall}\n`;
            cabrilloContent += `CATEGORY-OPERATOR: SINGLE-OP\n`;
            cabrilloContent += `CATEGORY-ASSISTED: NON-ASSISTED\n`;
            cabrilloContent += `CATEGORY-BAND: ALL\n`;
            cabrilloContent += `CATEGORY-MODE: MIXED\n`;
            cabrilloContent += `CATEGORY-POWER: HIGH\n`;
            cabrilloContent += `CATEGORY-TRANSMITTER: ONE\n`;
            cabrilloContent += `CATEGORY-STATION: FIXED\n`;
            cabrilloContent += `OPERATOR: ${myCall}\n`; 
            
            if (myLocator) {
                cabrilloContent += `LOCATION: ${myLocator}\n`;
            }
            cabrilloContent += `SOAPBOX: Log generated via Contest Logger Simulation.\n`;
            cabrilloContent += `CREATED-BY: Ham Radio Logger (Web Simulation)\n`;
            cabrilloContent += '\n';

            window.qsoList.forEach(qso => {
                const freqDisplay = getCabrilloBandFreq(qso.band);
                const exchangeSent = qso.exchangeSent;
                const exchangeRcvd = qso.exchangeRcvd;

                const qsoLine = `QSO: ${freqDisplay.padEnd(5)} ${qso.mode.padEnd(2)} ${qso.dateISO} ${qso.timeHHMM} ${qso.myCall.padEnd(10)} ${qso.rstSent.padEnd(3)} ${exchangeSent.padEnd(6)} ${qso.dxCall.padEnd(10)} ${qso.rstRcvd.padEnd(3)} ${exchangeRcvd.padEnd(6)}\n`;
                cabrilloContent += qsoLine;
            });

            cabrilloContent += `\nEND-OF-LOG:`;
            return cabrilloContent;
        }

        // 2. ADIF Generator (.adi)
        function generateAdifLog() {
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            let adifContent = `ADIF Exported by Ham Radio Logger\n`;
            adifContent += `Created on: ${new Date().toUTCString()}\n`;
            adifContent += `<ADIF_VER:5>3.1.4\n`;
            adifContent += `<PROGRAMID:19>HamRadioLogger\n`;
            adifContent += `<PROGRAMVERSION:7>1.0.0.0\n`;
            adifContent += `<EOH>\n\n`; // End of Header

            window.qsoList.forEach(qso => {
                const isVHF = isLocatorContest(qso.band);
                const bandForAdif = isVHF ? (qso.band === '2m' ? '2M' : qso.band === '70cm' ? '70CM' : `${qso.band}M`) : `${qso.band}M`;

                adifContent += `<QSO_DATE:${qso.dateYYMMDD.length}>${qso.dateYYMMDD}`;
                adifContent += `<TIME_ON:${qso.timeHHMM.length}>${qso.timeHHMM}`;
                adifContent += `<CALL:${qso.dxCall.length}>${qso.dxCall}`;
                adifContent += `<BAND:${bandForAdif.length}>${bandForAdif}`;
                adifContent += `<MODE:${qso.mode.length}>${qso.mode}`;
                adifContent += `<RST_SENT:${qso.rstSent.length}>${qso.rstSent}`;
                adifContent += `<RST_RCVD:${qso.rstRcvd.length}>${qso.rstRcvd}`;
                adifContent += `<MY_CALL:${qso.myCall.length}>${qso.myCall}`;
                
                if (isVHF || qso.dxLocator) {
                    // Maidenhead locator (дори за КВ, ако е въведен)
                    adifContent += `<GRIDSQUARE:${qso.dxLocator.length}>${qso.dxLocator}`;
                    adifContent += `<MY_GRIDSQUARE:${qso.myLocator.length}>${qso.myLocator}`;
                } else {
                    // Serial Number (TX/RX)
                    adifContent += `<SRX_STRING:${qso.exchangeRcvd.length}>${qso.exchangeRcvd}`;
                    adifContent += `<STX_STRING:${qso.exchangeSent.length}>${qso.exchangeSent}`;
                }
                
                adifContent += `<EOR>\n`; // End of Record
            });

            return adifContent;
        }

        // 3. Контест TXT/EDI-подобен Generator (.txt)
        // СТРУКТУРА: дата;час;позивна;1;RSTsent;Мой_Serial/Конст.;RSTrcvd;Получен_Serial/LOC;DX_LOCATOR;Разстояние;Празно;Мултипликатор;Празно;Празно;
        function generateEdiLog() {
            
            let ediContent = "";

            window.qsoList.forEach(qso => {
                const dateYYMMDD = qso.dateYYMMDD; 
                const timeHHMM = qso.timeHHMM; 

                const isLoc = isLocatorContest(qso.band);
                
                // --- КОНТРОЛ НА ПОЛЕТАТА СПОРЕД ВАШИЯ ФОРМАТ (14 ПОЛЕТА) ---
                
                // P3: Позивна на кореспондента (DX Call)
                const dxCall = qso.dxCall; 
                
                // P4: '1' (Константа за един оператор)
                const constantOne = '1';
                
                // P5: Изпратен RST (RST Sent)
                // EDI-подобният формат обикновено използва само две цифри (59)
                const rstSent = qso.rstSent.substring(0, 2); 
                
                // P6: Пореден брой мой QSO (Мой сериен номер)
                // За КВ: '001', '002'. За УКВ: '1' или '001'
                const sentExchange = isLoc ? '1' : qso.exchangeSent; 
                
                // P7: Получен RST (RST Rcvd) - '59'
                const rstRcvd = qso.rstRcvd.substring(0, 2); 
                
                // P8: Получен обмен (Serial/Locator)
                // Това е серийният номер за КВ ('056') или локаторът за УКВ ('KN12AA')
                const receivedExchange = qso.exchangeRcvd;
                
                // P9: DX Локатор (запълва се дори за КВ, ако е наличен)
                // ВАЖНО: Тук ще използваме qso.dxLocator, който се попълва от input полето
                const dxLocatorField = qso.dxLocator || '';
                
                // P10: Разстояние (км)
                // ТУК Е КОРЕКЦИЯТА: Използваме 'qso.distanceKm'
                const distanceField = qso.distanceKm || '';

                // P11: Празно поле
                const empty11 = ''; 

                // P12: Мултипликатор
                // Мултипликаторът е 'N', ако има валиден 4-символен DX локатор ИЛИ е КВ (по принцип)
                const multiplier = qso.dxLocator.length >= 4 ? 'N' : ''; 
                
                // P13: Празно поле
                const empty13 = '';
                
                // P14: Празно поле
                const empty14 = '';
                
                // --- ГЕНЕРИРАНЕ НА РЕДА (14 ПОЛЕТА) ---
                const row = [
                    dateYYMMDD, // P1
                    timeHHMM,   // P2
                    dxCall,     // P3
                    constantOne,// P4
                    rstSent,    // P5
                    sentExchange,// P6
                    rstRcvd,    // P7
                    receivedExchange, // P8
                    dxLocatorField, // P9 *** ТУК ВЕЧЕ ЩЕ Е DX ЛОКАТОРЪТ ***
                    distanceField,  // P10 *** ТУК ВЕЧЕ ЩЕ Е РАЗСТОЯНИЕТО ***
                    empty11,    // P11
                    multiplier, // P12
                    empty13,    // P13
                    empty14     // P14
                ];
                
                // EDI форматът завършва с точка и запетая, затова използваме join(';') + ';'
                ediContent += row.join(';') + ';\n'; 
            });

            return ediContent;
        }

    </script>

</body>
</html>