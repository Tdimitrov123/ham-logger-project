<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ham Radio Contest Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Персонализиран стил за по-добър вид на мобилен телефон */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        input[type="text"], input[type="number"], select {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .btn-primary {
            background-color: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #059669;
        }
        .btn-secondary {
            background-color: #f59e0b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d97706;
        }
        .qso-log {
            max-height: 40vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Контест Лог за Ham Radio</h1>

        <!-- 1. Настройки на оператора (Your Details) + Банд и Режим -->
        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Твоите настройки</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Твоите данни -->
                <div>
                    <label for="myCall" class="block text-sm font-medium text-gray-600 mb-1">Твоята позивна (Call)</label>
                    <input type="text" id="myCall" placeholder="LZ1XYZ" class="w-full" value="LZ5A">
                </div>
                <div>
                    <label for="myLocator" class="block text-sm font-medium text-gray-600 mb-1">Твоят локатор (Locator)</label>
                    <input type="text" id="myLocator" placeholder="KN32" class="w-full uppercase" value="KN32LV">
                </div>
                <div>
                    <label for="contestName" class="block text-sm font-medium text-gray-600 mb-1">Име на контеста</label>
                    <input type="text" id="contestName" placeholder="CQ-WW-SSB" class="w-full uppercase" value="IARU-HF-2025">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mt-4">
                <!-- Избор на Банд (преместено) -->
                <div>
                    <label for="band" class="block text-sm font-medium text-gray-600 mb-1">Текуща Банда (Band)</label>
                    <select id="band" class="w-full p-2 border border-gray-300 rounded-lg">
                        <!-- Добавени 2м и 70см -->
                        <option value="160">160м (1.8MHz)</option>
                        <option value="80">80м (3.5MHz)</option>
                        <option value="40">40м (7MHz)</option>
                        <option value="20" selected>20м (14MHz)</option>
                        <option value="15">15м (21MHz)</option>
                        <option value="10">10м (28MHz)</option>
                        <option value="6">6м (50MHz)</option>
                        <option value="2m">2м (144MHz)</option>
                        <option value="70cm">70см (433MHz)</option>
                    </select>
                </div>
                <!-- Избор на Режим (преместено) -->
                <div>
                    <label for="mode" class="block text-sm font-medium text-gray-600 mb-1">Текущ Режим (Mode)</label>
                    <select id="mode" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="SSB">SSB</option>
                        <option value="CW">CW</option>
                        <option value="FM">FM</option>
                        <option value="RY">RTTY</option>
                    </select>
                </div>
                <!-- Изпратен RST (фиксиран) -->
                <div>
                    <label for="rstSent" class="block text-sm font-medium text-gray-600 mb-1">Изпратен RST</label>
                    <input type="text" id="rstSent" value="599" class="w-full" disabled>
                </div>
            </div>
        </div>

        <!-- 2. Форма за въвеждане на QSO -->
        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Въвеждане на QSO</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="dxCall" class="block text-sm font-medium text-gray-600 mb-1">Позивна на кореспондента (DX Call)</label>
                    <input type="text" id="dxCall" placeholder="K1ABC" class="w-full text-lg font-bold uppercase" autofocus>
                </div>
                <div>
                    <label for="serialNumber" class="block text-sm font-medium text-gray-600 mb-1">Получен номер (Serial/RST)</label>
                    <input type="text" id="serialNumber" placeholder="001 / 599" class="w-full text-lg font-bold">
                </div>
            </div>
            
            <!-- Добавено поле за локатор на кореспондента -->
            <div class="mt-4">
                 <label for="dxLocator" class="block text-sm font-medium text-gray-600 mb-1">Локатор на кореспондента (DX Locator)</label>
                 <input type="text" id="dxLocator" placeholder="FN42" class="w-full text-lg font-bold uppercase">
            </div>

            <button onclick="addQSO()" class="btn-primary w-full mt-4">
                <span class="text-xl font-bold">+</span> Логване на QSO (Enter)
            </button>
        </div>

        <!-- 3. Лог на QSO-тата и експорт -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Лог на QSO-тата (<span id="qsoCount">0</span>)</h2>
            
            <!-- Показване на лога -->
            <div id="qsoLog" class="qso-log border p-3 rounded-lg bg-gray-50 mb-4 text-sm whitespace-pre-wrap">
                <!-- Тук ще се показват логнатите QSO-та -->
            </div>

            <button onclick="exportCabrillo()" class="btn-secondary w-full">
                Експорт на Cabrillo Файл
            </button>
        </div>
        
        <!-- Скрито поле за съобщения -->
        <div id="messageBox" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden transition-all"></div>
    </div>

    <script>
        // Глобален масив за съхранение на QSO-тата
        let qsoList = [];
        // Сериен номер, който изпращаме (автоматично нараства)
        let sentSerialNumber = 1; 

        // Инициализация при зареждане на страницата
        document.addEventListener('DOMContentLoaded', () => {
            // Зареждане на запазените данни от localStorage (за да симулираме запазване на Android)
            loadState();
            updateQsoDisplay();
            
            // Добавяне на listener за Enter (клавиш 13) за бързо логване
            document.getElementById('dxCall').addEventListener('keyup', handleEnterKey);
            document.getElementById('serialNumber').addEventListener('keyup', handleEnterKey);
            document.getElementById('dxLocator').addEventListener('keyup', handleEnterKey);
        });

        function handleEnterKey(event) {
             if (event.keyCode === 13) {
                 addQSO();
                 // Предотвратяване на стандартното поведение на Enter
                 event.preventDefault(); 
             }
        }

        function loadState() {
            const savedQSOs = localStorage.getItem('cabrilloQSOs');
            if (savedQSOs) {
                qsoList = JSON.parse(savedQSOs);
            }
            const savedSerial = localStorage.getItem('cabrilloSerial');
            if (savedSerial) {
                sentSerialNumber = parseInt(savedSerial, 10);
            }
        }

        function saveState() {
            localStorage.setItem('cabrilloQSOs', JSON.stringify(qsoList));
            localStorage.setItem('cabrilloSerial', sentSerialNumber);
        }

        function showMessage(msg, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.classList.remove('bg-red-500', 'bg-green-500', 'hidden');
            box.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'block');
            setTimeout(() => {
                box.classList.remove('block');
                box.classList.add('hidden');
            }, 3000);
        }

        function getCurrentTimeUTC() {
            const now = new Date();
            // Cabrillo изисква UTC време във формат YYYY-MM-DD HHMM
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, '0');
            const day = String(now.getUTCDate()).padStart(2, '0');
            const hours = String(now.getUTCHours()).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');

            return {
                date: `${year}-${month}-${day}`,
                time: `${hours}${minutes}`
            };
        }

        function addQSO() {
            const dxCall = document.getElementById('dxCall').value.trim().toUpperCase();
            const receivedSerial = document.getElementById('serialNumber').value.trim();
            const dxLocator = document.getElementById('dxLocator').value.trim().toUpperCase(); // Ново поле
            
            const band = document.getElementById('band').value;
            const mode = document.getElementById('mode').value;
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const myLocator = document.getElementById('myLocator').value.trim().toUpperCase(); // Твоят локатор
            const rstSent = document.getElementById('rstSent').value;

            if (!dxCall || !receivedSerial || !myCall) {
                showMessage('Моля, попълни Позивна на кореспондента, Получен номер и Твоята позивна!', true);
                return;
            }

            const timeUTC = getCurrentTimeUTC();
            
            // Определяме дали обменяме сериен номер или локатор
            // За Cabrillo, обменът може да е RST + Serial ИЛИ RST + Locator
            const exchangeSent = isLocatorContest(band) ? myLocator : String(sentSerialNumber).padStart(3, '0');
            const exchangeRcvd = isLocatorContest(band) ? dxLocator : receivedSerial.padStart(3, '0');


            const newQSO = {
                band: band, 
                mode: mode, 
                date: timeUTC.date, 
                time: timeUTC.time,
                myCall: myCall,
                rstSent: rstSent,
                exchangeSent: exchangeSent, // Изпратен обмен (Serial или Locator)
                dxCall: dxCall,
                rstRcvd: rstSent, // Приемаме 599 за RST, или може да се промени
                exchangeRcvd: exchangeRcvd // Получен обмен (Serial или Locator)
            };

            qsoList.push(newQSO);
            
            // Увеличаване на нашия сериен номер само ако е HF контест
            if (!isLocatorContest(band)) {
                sentSerialNumber++; 
            }
            
            // Запазване на състоянието
            saveState();

            // Обновяване на дисплея и почистване на полетата за въвеждане
            updateQsoDisplay();
            document.getElementById('dxCall').value = '';
            document.getElementById('serialNumber').value = '';
            document.getElementById('dxLocator').value = '';
            document.getElementById('dxCall').focus(); // Връщане на фокуса за бързо въвеждане
            
            showMessage(`Успешно логнато QSO с ${dxCall} (Обмен: ${exchangeRcvd})`, false);
        }

        // Проверява дали банда е VHF/UHF (където обикновено се обменя локатор)
        function isLocatorContest(band) {
            return band === '2m' || band === '70cm';
        }

        function updateQsoDisplay() {
            const logElement = document.getElementById('qsoLog');
            const countElement = document.getElementById('qsoCount');
            logElement.innerHTML = ''; // Изчистване
            
            countElement.textContent = qsoList.length;

            if (qsoList.length === 0) {
                logElement.textContent = 'Няма логнати QSO-та.';
                return;
            }

            // Показваме последните 10 QSO-та
            const displayList = qsoList.slice(-10).reverse(); 
            
            let displayHtml = '';
            displayList.forEach(qso => {
                const bandDisplay = qso.band.includes('m') ? qso.band : `${qso.band}м`;
                
                // Проверяваме дали обменяме локатор или сериен номер
                const exchangeLabel = isLocatorContest(qso.band) ? 'LOC' : '№';

                displayHtml += `<div class="p-2 border-b border-gray-200 last:border-b-0 flex justify-between items-center flex-wrap">
                    <span class="font-mono text-gray-700 w-1/4">${qso.time}Z</span>
                    <span class="font-semibold text-blue-600 w-1/4">${qso.dxCall}</span>
                    <span class="text-sm text-gray-500 w-1/4">${bandDisplay}/${qso.mode}</span>
                    <span class="text-green-600 font-bold w-1/4 text-right">${exchangeLabel} ${qso.exchangeRcvd}</span>
                </div>`;
            });
            logElement.innerHTML = displayHtml;
        }

        function getCabrilloBandFreq(band) {
            // Cabrillo изисква FREQ в MHz
            switch(band) {
                case '160': return '1.8M';
                case '80': return '3.5M';
                case '40': return '7M';
                case '20': return '14M';
                case '15': return '21M';
                case '10': return '28M';
                case '6': return '50M';
                case '2m': return '144M';
                case '70cm': return '433M';
                default: return '14M';
            }
        }

        function generateCabrilloLog() {
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const operator = document.getElementById('operator').value.trim().toUpperCase() || myCall;
            const contestName = document.getElementById('contestName').value.trim().toUpperCase();
            const myLocator = document.getElementById('myLocator').value.trim().toUpperCase();
            
            let cabrilloContent = `START-OF-LOG: 3.0\n`;
            cabrilloContent += `CONTEST: ${contestName}\n`;
            cabrilloContent += `CALLSIGN: ${myCall}\n`;
            cabrilloContent += `CATEGORY-OPERATOR: SINGLE-OP\n`;
            cabrilloContent += `CATEGORY-ASSISTED: NON-ASSISTED\n`;
            cabrilloContent += `CATEGORY-BAND: ALL\n`;
            cabrilloContent += `CATEGORY-MODE: MIXED\n`;
            cabrilloContent += `CATEGORY-POWER: HIGH\n`;
            cabrilloContent += `CATEGORY-TRANSMITTER: ONE\n`;
            cabrilloContent += `CATEGORY-STATION: FIXED\n`;
            cabrilloContent += `OPERATOR: ${operator}\n`;
            
            // Твоят локатор се добавя като LOCATION
            if (myLocator) {
                 cabrilloContent += `LOCATION: ${myLocator}\n`;
            }
            cabrilloContent += `SOAPBOX: Log generated via Contest Logger Simulation.\n`;
            cabrilloContent += `CREATED-BY: Ham Radio Logger (Web Simulation)\n`;
            
            cabrilloContent += '\n';

            // Генериране на QSO редовете
            qsoList.forEach(qso => {
                // Cabrillo QSO Format:
                // QSO: <freq> <mode> <date> <time> <mycall> <rst_sent> <exch_sent> <dxcall> <rst_rcvd> <exch_rcvd>
                
                const freqDisplay = getCabrilloBandFreq(qso.band);
                
                // Обменът е или сериен номер (Serial/001), или локатор (KN32LV)
                const exchangeSent = qso.exchangeSent;
                const exchangeRcvd = qso.exchangeRcvd;

                // Използваме padEnd за подравняване, което е полезно за четливост в Cabrillo
                const qsoLine = `QSO: ${freqDisplay.padEnd(5)} ${qso.mode.padEnd(2)} ${qso.date} ${qso.time} ${qso.myCall.padEnd(10)} ${qso.rstSent.padEnd(3)} ${exchangeSent.padEnd(6)} ${qso.dxCall.padEnd(10)} ${qso.rstRcvd.padEnd(3)} ${exchangeRcvd.padEnd(6)}\n`;
                cabrilloContent += qsoLine;
            });

            cabrilloContent += `\nEND-OF-LOG:`;

            return cabrilloContent;
        }

        function exportCabrillo() {
            if (qsoList.length === 0) {
                showMessage('Няма логнати QSO-та за експорт.', true);
                return;
            }

            const cabrilloData = generateCabrilloLog();
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const contestName = document.getElementById('contestName').value.trim().toUpperCase();
            // Cabrillo файловете обикновено завършват на .log
            const fileName = `${myCall}-${contestName}.log`.toLowerCase(); 

            // Създаване на Blob обект с Cabrillo данните
            const blob = new Blob([cabrilloData], { type: 'text/plain;charset=utf-8' });

            // Създаване на временна връзка за изтегляне
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName; 
            
            // Симулиране на кликване за стартиране на изтеглянето
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage(`Cabrillo файлът '${fileName}' беше успешно генериран и изтеглен!`, false);
        }
    </script>

</body>
</html>