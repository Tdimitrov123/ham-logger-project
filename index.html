<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ham Radio Contest Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Персонализиран стил за модерен тъмен режим (Dark Mode) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Тъмен фон */
            color: #f3f4f6; /* Светъл текст */
        }
        .card {
            background-color: #374151; /* По-светъл цвят за "картите" */
            border: 1px solid #4b5563;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }
        h1, h2 {
            color: #d1d5db;
        }
        label {
            color: #9ca3af;
        }
        input[type="text"], input[type="number"], select {
            background-color: #4b5563; /* Полетата са по-тъмни */
            color: #f3f4f6;
            border: 1px solid #6b7280;
            padding: 0.75rem;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            border-color: #6366f1; /* Индиго за фокус */
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }

        /* Основен бутон за логване: Ярко зелено */
        .btn-primary {
            background-color: #10b981;
            color: #0d121c; /* По-тъмен текст за по-добър контраст */
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        
        /* Бутон за Експорт: Кехлибар/Оранжево */
        .btn-secondary {
            background-color: #f59e0b;
            color: #1f2937;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #d97706;
        }

        .qso-log {
            max-height: 40vh;
            overflow-y: auto;
        }
        /* Стилове за лога в тъмен режим */
        .log-item {
            border-color: #4b5563 !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-indigo-400 mb-8 text-center">
            <span class="text-white">Ham Radio</span> Contest Logger
        </h1>

        <!-- 1. Настройки на оператора (Your Details) + Банд и Режим -->
        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-white">Твоите настройки</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Твоите данни -->
                <div>
                    <label for="myCall" class="block text-sm font-medium mb-1">Твоята позивна (Call)</label>
                    <input type="text" id="myCall" placeholder="LZ1XYZ" class="w-full" value="LZ5A">
                </div>
                <div>
                    <label for="myLocator" class="block text-sm font-medium mb-1">Твоят локатор (Locator)</label>
                    <input type="text" id="myLocator" placeholder="KN32" class="w-full uppercase" value="KN32LV">
                </div>
                <div>
                    <label for="contestName" class="block text-sm font-medium mb-1">Име на контеста</label>
                    <input type="text" id="contestName" placeholder="CQ-WW-SSB" class="w-full uppercase" value="IARU-HF-2025">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mt-4">
                <!-- Избор на Банд (преместено) -->
                <div>
                    <label for="band" class="block text-sm font-medium mb-1">Текуща Банда (Band)</label>
                    <select id="band" class="w-full p-2">
                        <option value="160">160м (1.8MHz)</option>
                        <option value="80">80м (3.5MHz)</option>
                        <option value="40">40м (7MHz)</option>
                        <option value="20" selected>20м (14MHz)</option>
                        <option value="15">15м (21MHz)</option>
                        <option value="10">10м (28MHz)</option>
                        <option value="6">6м (50MHz)</option>
                        <option value="2m">2м (144MHz)</option>
                        <option value="70cm">70см (433MHz)</option>
                    </select>
                </div>
                <!-- Избор на Режим (преместено) -->
                <div>
                    <label for="mode" class="block text-sm font-medium mb-1">Текущ Режим (Mode)</label>
                    <select id="mode" class="w-full p-2">
                        <option value="SSB">SSB</option>
                        <option value="CW">CW</option>
                        <option value="FM">FM</option>
                        <option value="RY">RTTY</option>
                    </select>
                </div>
                <!-- Изпратен RST (фиксиран) -->
                <div>
                    <label for="rstSent" class="block text-sm font-medium mb-1">Изпратен RST</label>
                    <input type="text" id="rstSent" value="599" class="w-full" disabled>
                </div>
            </div>
        </div>

        <!-- 2. Форма за въвеждане на QSO -->
        <div class="card mb-6 border-indigo-500 border-2">
            <h2 class="text-xl font-semibold mb-4 text-white">Въвеждане на QSO</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Позивна -->
                <div>
                    <label for="dxCall" class="block text-sm font-medium mb-1">Позивна (DX Call)</label>
                    <input type="text" id="dxCall" placeholder="K1ABC" class="w-full text-xl font-bold uppercase" autofocus>
                </div>
                <!-- Получен обмен (Serial/Locator) -->
                <div>
                    <label for="serialNumber" class="block text-sm font-medium mb-1">Получен Обмен (Serial/Locator)</label>
                    <input type="text" id="serialNumber" placeholder="001 / KN32LV" class="w-full text-xl font-bold">
                </div>
                <!-- Локатор на кореспондента (DX Locator - за VHF) -->
                <div>
                    <label for="dxLocator" class="block text-sm font-medium mb-1">DX Локатор (за VHF)</label>
                    <input type="text" id="dxLocator" placeholder="FN42" class="w-full text-xl font-bold uppercase">
                </div>
            </div>
            
            <button onclick="addQSO()" class="btn-primary w-full mt-6">
                <span class="text-2xl font-black">LOG QSO (Enter)</span>
            </button>
        </div>

        <!-- 3. Лог на QSO-тата и експорт -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-white">
                Лог на QSO-тата (<span id="qsoCount" class="text-yellow-400 font-extrabold text-2xl">0</span>)
                <span id="authStatus" class="text-xs text-green-500 font-normal"> (Свързване...)</span>
            </h2>
            
            <!-- Показване на лога -->
            <div id="qsoLog" class="qso-log border p-3 rounded-lg bg-gray-600 mb-4 text-sm whitespace-pre-wrap">
                <p class="text-center text-gray-400">Зареждане на лога...</p>
            </div>

            <button onclick="exportCabrillo()" class="btn-secondary w-full">
                Експорт на Cabrillo Файл
            </button>
        </div>
        
        <!-- Скрито поле за съобщения -->
        <div id="messageBox" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden transition-all"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобални променливи за Firebase
        let db = null; // Инициализираме с null
        let auth = null; // Инициализираме с null
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Глобален масив за съхранение на QSO-тата
        window.qsoList = [];
        // Сериен номер, който изпращаме (автоматично нараства)
        window.sentSerialNumber = 1; 

        // Инициализация на Firebase и автентикация
        async function initializeFirebase() {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Проверка за липсваща конфигурация (случай за външно изпълнение като GitHub Pages)
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                console.warn("FIREBASE WARNING: Missing or empty __firebase_config. The logger will run without cloud persistence.");
                document.getElementById('authStatus').textContent = '(Логва локално, без облак)';
                document.getElementById('qsoLog').innerHTML = '<p class="text-center text-red-400 p-4">Няма връзка с базата данни (липсва конфигурация). Логът няма да се запази при презареждане на страницата!</p>';
                return false; // Показва неуспешна инициализация
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Автентикация
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                document.getElementById('authStatus').textContent = '(Свързан с облака)';
                return true; // Показва успешна инициализация
                
            } catch (error) {
                console.error("Грешка при инициализация на Firebase:", error);
                document.getElementById('authStatus').textContent = '(Грешка при свързване)';
                document.getElementById('qsoLog').innerHTML = '<p class="text-center text-red-400 p-4">Критична грешка при свързване с Firebase. Вижте конзолата за детайли.</p>';
                return false; // Показва неуспешна инициализация
            }
        }

        // Зареждане на данните от Firestore
        function loadDataFromFirestore() {
            if (!db || !auth) return; // Не прави нищо, ако Firebase не е инициализиран

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    // Пътят към документа е: /artifacts/{appId}/users/{userId}/contest_logs/qso_data
                    const logDocRef = doc(db, `artifacts/${appId}/users/${userId}/contest_logs/qso_data`);

                    // Слушане за промени в реално време
                    onSnapshot(logDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            window.qsoList = data.qsoList || [];
                            window.sentSerialNumber = data.sentSerialNumber || 1;
                        } else {
                            // Ако документът не съществува, го създаваме с начални данни
                            saveState(); 
                        }
                        updateQsoDisplay(); // Обновяваме дисплея след зареждане/промяна
                    }, (error) => {
                        console.error("Грешка при слушане на Firestore:", error);
                        showMessage('Грешка при зареждане на лога от облака.', true);
                        updateQsoDisplay(); // Обновяваме дисплея дори при грешка, за да не стои "Зареждане..."
                    });
                }
            });
        }

        // Запазване на състоянието във Firestore
        async function saveState() {
            if (!userId || !db) return; // Проверка дали Firebase е инициализиран

            const logData = {
                qsoList: window.qsoList,
                sentSerialNumber: window.sentSerialNumber,
                lastUpdate: new Date().toISOString()
            };

            try {
                const logDocRef = doc(db, `artifacts/${appId}/users/${userId}/contest_logs/qso_data`);
                await setDoc(logDocRef, logData);
            } catch (error) {
                console.error("Грешка при запис във Firestore:", error);
                showMessage('Грешка при запазване на QSO. Проверете връзката си.', true);
            }
        }

        // Присвояване на глобалните функции към window, за да са достъпни от HTML
        window.addQSO = addQSO;
        window.exportCabrillo = exportCabrillo;

        // Инициализация при зареждане на страницата
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase().then((success) => {
                if (success) {
                    loadDataFromFirestore();
                } else {
                    // Ако Firebase се е провалил (напр. липсва конфигурация), 
                    // просто стартираме локалния дисплей
                    updateQsoDisplay();
                }
            });
            
            // Добавяне на listener за Enter (клавиш 13) за бързо логване
            document.getElementById('dxCall').addEventListener('keyup', handleEnterKey);
            document.getElementById('serialNumber').addEventListener('keyup', handleEnterKey);
            document.getElementById('dxLocator').addEventListener('keyup', handleEnterKey);
        });

        function handleEnterKey(event) {
            if (event.keyCode === 13) {
                addQSO();
                // Предотвратяване на стандартното поведение на Enter
                event.preventDefault(); 
            }
        }

        function showMessage(msg, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.classList.remove('bg-red-500', 'bg-green-500', 'hidden');
            box.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'block');
            setTimeout(() => {
                box.classList.remove('block');
                box.classList.add('hidden');
            }, 3000);
        }

        function getCurrentTimeUTC() {
            const now = new Date();
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, '0');
            const day = String(now.getUTCDate()).padStart(2, '0');
            const hours = String(now.getUTCHours()).padStart(2, '0');
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');

            return {
                date: `${year}-${month}-${day}`,
                time: `${hours}${minutes}`
            };
        }

        function addQSO() {
            const dxCall = document.getElementById('dxCall').value.trim().toUpperCase();
            const receivedExchangeRaw = document.getElementById('serialNumber').value.trim();
            const dxLocator = document.getElementById('dxLocator').value.trim().toUpperCase(); 
            
            const band = document.getElementById('band').value;
            const mode = document.getElementById('mode').value;
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const myLocator = document.getElementById('myLocator').value.trim().toUpperCase(); 
            const rstSent = document.getElementById('rstSent').value;

            if (!dxCall || !myCall) {
                showMessage('Моля, попълни Позивна на кореспондента и Твоята позивна!', true);
                return;
            }

            const timeUTC = getCurrentTimeUTC();
            
            // Определяме дали обменяме сериен номер или локатор
            const isLocator = isLocatorContest(band);

            // Изпратен обмен (Serial или Locator)
            const exchangeSent = isLocator ? myLocator : String(window.sentSerialNumber).padStart(3, '0'); 
            
            // Получен обмен (Locator или Serial)
            const exchangeRcvd = isLocator ? (dxLocator || receivedExchangeRaw).toUpperCase() : receivedExchangeRaw.padStart(3, '0');
            
            const newQSO = {
                band: band, 
                mode: mode, 
                date: timeUTC.date, 
                time: timeUTC.time,
                myCall: myCall,
                rstSent: rstSent,
                exchangeSent: exchangeSent, 
                dxCall: dxCall,
                rstRcvd: rstSent, // Приемаме 599 за RST Received
                exchangeRcvd: exchangeRcvd
            };

            window.qsoList.push(newQSO);
            
            // Увеличаване на нашия сериен номер само ако е HF контест (Serial)
            if (!isLocator) {
                window.sentSerialNumber++; 
            }
            
            // Запазване на състоянието в облака (само ако db е инициализиран)
            if(db) {
                saveState();
            } else {
                // Ако няма връзка с облака, просто обновяваме UI
                showMessage(`Успешно логнато QSO с ${dxCall} (Обмен: ${exchangeRcvd}). Локално.`, false);
            }

            // Обновяване на дисплея и почистване на полетата за въвеждане
            document.getElementById('dxCall').value = '';
            document.getElementById('serialNumber').value = '';
            document.getElementById('dxLocator').value = '';
            document.getElementById('dxCall').focus(); // Връщане на фокуса за бързо въвеждане
            
            updateQsoDisplay(); // Обновяваме дисплея след добавяне на QSO
        }

        // Проверява дали банда е VHF/UHF (където обикновено се обменя локатор)
        function isLocatorContest(band) {
            return band === '2m' || band === '70cm';
        }

        function updateQsoDisplay() {
            const logElement = document.getElementById('qsoLog');
            const countElement = document.getElementById('qsoCount');
            logElement.innerHTML = ''; // Изчистване
            
            countElement.textContent = window.qsoList.length;

            if (window.qsoList.length === 0) {
                logElement.innerHTML = '<p class="text-center text-gray-400 p-4">Няма логнати QSO-та.</p>';
                return;
            }

            // Показваме последните 10 QSO-та, обърнати
            const displayList = window.qsoList.slice(-10).reverse(); 
            
            let displayHtml = '';
            displayList.forEach(qso => {
                const bandDisplay = qso.band.includes('m') || qso.band.includes('cm') ? qso.band : `${qso.band}м`;
                
                // Проверяваме дали обменяме локатор или сериен номер
                const exchangeLabel = isLocatorContest(qso.band) ? 'LOC' : '№';

                displayHtml += `<div class="p-2 border-b log-item last:border-b-0 flex justify-between items-center flex-wrap">
                    <span class="font-mono text-gray-300 w-1/4">${qso.time}Z</span>
                    <span class="font-bold text-indigo-400 w-1/4">${qso.dxCall}</span>
                    <span class="text-xs text-gray-400 w-1/4">${bandDisplay}/${qso.mode}</span>
                    <span class="text-yellow-400 font-extrabold w-1/4 text-right">${exchangeLabel} ${qso.exchangeRcvd}</span>
                </div>`;
            });
            logElement.innerHTML = displayHtml;
        }

        function getCabrilloBandFreq(band) {
            // Cabrillo изисква FREQ в MHz
            switch(band) {
                case '160': return '1.8M';
                case '80': return '3.5M';
                case '40': return '7M';
                case '20': return '14M';
                case '15': return '21M';
                case '10': return '28M';
                case '6': return '50M';
                case '2m': return '144M';
                case '70cm': return '433M';
                default: return '14M';
            }
        }

        function generateCabrilloLog() {
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const contestName = document.getElementById('contestName').value.trim().toUpperCase();
            const myLocator = document.getElementById('myLocator').value.trim().toUpperCase();
            
            let cabrilloContent = `START-OF-LOG: 3.0\n`;
            cabrilloContent += `CONTEST: ${contestName}\n`;
            cabrilloContent += `CALLSIGN: ${myCall}\n`;
            cabrilloContent += `CATEGORY-OPERATOR: SINGLE-OP\n`;
            cabrilloContent += `CATEGORY-ASSISTED: NON-ASSISTED\n`;
            cabrilloContent += `CATEGORY-BAND: ALL\n`;
            cabrilloContent += `CATEGORY-MODE: MIXED\n`;
            cabrilloContent += `CATEGORY-POWER: HIGH\n`;
            cabrilloContent += `CATEGORY-TRANSMITTER: ONE\n`;
            cabrilloContent += `CATEGORY-STATION: FIXED\n`;
            cabrilloContent += `OPERATOR: ${myCall}\n`; 
            
            if (myLocator) {
                cabrilloContent += `LOCATION: ${myLocator}\n`;
            }
            cabrilloContent += `SOAPBOX: Log generated via Contest Logger Simulation.\n`;
            cabrilloContent += `CREATED-BY: Ham Radio Logger (Web Simulation) with Firebase\n`;
            
            cabrilloContent += '\n';

            // Генериране на QSO редовете
            window.qsoList.forEach(qso => {
                // QSO: <freq> <mode> <date> <time> <mycall> <rst_sent> <exch_sent> <dxcall> <rst_rcvd> <exch_rcvd>
                
                const freqDisplay = getCabrilloBandFreq(qso.band);
                const exchangeSent = qso.exchangeSent;
                const exchangeRcvd = qso.exchangeRcvd;

                // Използваме padEnd за подравняване, което е полезно за четливост в Cabrillo
                const qsoLine = `QSO: ${freqDisplay.padEnd(5)} ${qso.mode.padEnd(2)} ${qso.date} ${qso.time} ${qso.myCall.padEnd(10)} ${qso.rstSent.padEnd(3)} ${exchangeSent.padEnd(6)} ${qso.dxCall.padEnd(10)} ${qso.rstRcvd.padEnd(3)} ${exchangeRcvd.padEnd(6)}\n`;
                cabrilloContent += qsoLine;
            });

            cabrilloContent += `\nEND-OF-LOG:`;

            return cabrilloContent;
        }

        function exportCabrillo() {
            if (window.qsoList.length === 0) {
                showMessage('Няма логнати QSO-та за експорт.', true);
                return;
            }

            const cabrilloData = generateCabrilloLog();
            const myCall = document.getElementById('myCall').value.trim().toUpperCase();
            const contestName = document.getElementById('contestName').value.trim().toUpperCase();
            const fileName = `${myCall}-${contestName}.log`.toLowerCase(); 

            const blob = new Blob([cabrilloData], { type: 'text/plain;charset=utf-8' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName; 
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage(`Cabrillo файлът '${fileName}' беше успешно генериран и изтеглен!`, false);
        }
    </script>

</body>
</html>